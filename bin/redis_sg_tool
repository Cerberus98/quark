#!/usr/bin/python
# Copyright 2014 Openstack Foundation
# All Rights Reserved.
#
#    Licensed under the Apache License, Version 2.0 (the "License"); you may
#    not use this file except in compliance with the License. You may obtain
#    a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#    License for the specific language governing permissions and limitations
#    under the License.

"""Quark Redis Security Groups CLI tool.

Usage: redis_sg_tool [-h] [--config-file PATH]
    redis_sg_tool test-connection
    redis_sg_tool vifs-in-redis
    redis_sg_tool num-groups
    redis_sg_tool ports-with-groups
    redis_sg_tool write-groups [--yarly]

Options:
    -h --help       Show this screen.
    --version       Show version.
    --config-file PATH  Use a different config file path
"""

import sys

import docopt
import netaddr
from neutron.common import config
import neutron.context
from oslo.config import cfg

from quark.db import api as db_api
from quark.security_groups import redis_client


class QuarkRedisTool(object):
    def __init__(self, arguments):
        self._args = arguments
        config_args = []
        if self._args["--config-file"]:
            config_args.append(self._args["--config-file"])

        config.init(config_args)
        if not cfg.CONF.config_file:
            sys.exit(_("ERROR: Unable to find configuration file via the "
                       "default search paths (~/.neutron/, ~/, /etc/neutron/, "
                       "/etc/) and the '--config-file' option!"))

    def dispatch(self):
        if self._args["test-connection"]:
            self.test_connection()
        elif self._args["vifs-in-redis"]:
            self.vif_count()
        elif self._args["num-groups"]:
            self.num_groups()
        elif self._args["ports-with-groups"]:
            self.ports_with_groups()
        elif self._args["write-groups"]:
            dryrun = True
            if "--yarly" in self._args and self._args["--yarly"]:
                dryrun = False
            print self._args, dryrun
            self.write_groups(dryrun)

    def _get_connection(self, use_master=False):
        client = redis_client.Client(use_master=use_master)
        try:
            result = client.echo("connected")
            if result == "connected":
                return client
        except Exception, e:
            print e

    def test_connection(self):
        client = self._get_connection()
        if client:
            print "Connected Successfully"
        else:
            print "Could not connect to Redis"

    def vif_count(self):
        client = self._get_connection()
        print client.vif_count()

    def num_groups(self):
        ctx = neutron.context.get_admin_context()
        print db_api.security_group_count(ctx)

    def ports_with_groups(self):
        ctx = neutron.context.get_admin_context()
        print db_api.ports_with_security_groups_count(ctx)

    def write_groups(self, dryrun=False):
        client = self._get_connection(use_master=not dryrun)
        ctx = neutron.context.get_admin_context()
        ports_with_groups = db_api.ports_with_security_groups_find(ctx).all()
        print "Preparing to write rules for %s ports" % len(ports_with_groups)
        for port in ports_with_groups:
            mac = netaddr.EUI(port["mac_address"])
            print "Writing rules for port %s on device %s" % (
                mac, port["device_id"])

            if not dryrun:
                payload = client.serialize(port.security_groups)
                client.apply_rules(port["device_id"], port["mac_address"],
                                   payload)


if __name__ == "__main__":
    arguments = docopt.docopt(__doc__, version="Quark Redis CLI 0.1")
    redis_tool = QuarkRedisTool(arguments)
    redis_tool.dispatch()
